# 飞书通知配置指南

## 功能说明

系统现在支持通过飞书机器人发送股票推荐报告，包含：

- 📊 数据分析概览（分析股票数、数据时间范围等）
- 🎯 推荐股票列表（前10个最佳推荐）
- 💰 盈利预测信息（预期收益、成功率、目标价格、止损价等）
- ⚠️  风险提示

## 配置步骤

### 1. 创建飞书机器人

1. 打开飞书群组
2. 点击群组设置 → 群机器人 → 添加机器人
3. 选择"自定义机器人"
4. 设置机器人名称和描述（例如：股票推荐助手）
5. 复制生成的 **Webhook 地址**

### 2. 配置 webhook 地址

编辑 `config/config.yaml`，找到 `notification.feishu` 部分：

```yaml
notification:
  # 启用通知
  enabled: true
  # 启用飞书渠道
  enabled_channels:
    - feishu
  
  # 飞书推送配置
  feishu:
    # 替换为你的 webhook 地址
    webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    # 如果启用了签名校验，填写密钥（可选）
    secret: ""
```

### 3. 测试飞书通知

运行测试脚本验证配置：

```bash
python test_feishu_send.py
```

如果配置正确，你的飞书群组会收到一条包含5个测试推荐的卡片消息。

## 使用方法

### 方法一：命令行启用通知

```bash
# 运行分析并发送飞书通知
python run.py --local --min-score 50 --notify
```

### 方法二：配置文件启用

在 `config/config.yaml` 中设置：

```yaml
notification:
  enabled: true  # 启用通知
  enabled_channels:
    - feishu
```

然后正常运行：

```bash
python run.py --local --min-score 50
```

## 卡片内容说明

飞书推荐报告卡片包含以下信息：

### 1. 数据信息部分
- **分析股票数**：本次分析的股票总数
- **数据时间范围**：使用的历史数据时间跨度
- **平均数据点数**：每只股票的平均交易日数据
- **推荐数量**：符合条件的推荐数量

### 2. 推荐列表（前10个）
每个推荐包含：
- 🥇/🥈/🥉 排名标识
- **股票名称和代码**
- **推荐类型**：买入/持有/观察
- **评分**：综合评分（0-100）
- **当前价格**
- **策略**：采用的交易策略
- **盈利预测**：
  - 预期收益率和成功概率
  - 三档目标价格（保守/适中/激进）
  - 止损价格
- **推荐理由**：技术分析要点

### 3. 风险提示
- 投资风险提醒
- 报告生成时间

## 高级配置

### 启用签名校验（可选）

如果在创建飞书机器人时启用了签名校验：

1. 复制机器人的签名密钥（secret）
2. 在配置文件中填写：

```yaml
feishu:
  webhook_url: "https://open.feishu.cn/open-apis/bot/v2/hook/xxxx"
  secret: "your_secret_key_here"
```

### 自定义通知内容

你可以修改 `src/notification/notifier.py` 中的 `send_report_card` 方法来自定义卡片内容。

## 故障排除

### 问题1：通知发送失败

**可能原因**：
- webhook_url 配置错误
- 网络连接问题
- 机器人被禁用或删除
- 签名校验失败

**解决方法**：
1. 检查 webhook_url 是否完整且正确
2. 验证网络连接
3. 重新创建机器人
4. 检查 secret 配置（如果启用了签名）

### 问题2：收不到通知

**可能原因**：
- `notification.enabled` 未设置为 `true`
- `enabled_channels` 中没有包含 `feishu`
- 运行时没有使用 `--notify` 参数（如果配置中 enabled 为 false）

**解决方法**：
1. 检查配置文件中的 `notification.enabled` 设置
2. 确认 `enabled_channels` 包含 `feishu`
3. 使用 `--notify` 参数运行或在配置中启用

### 问题3：卡片显示不完整

**可能原因**：
- 推荐数量过多（飞书卡片有大小限制）
- 某些字段数据缺失

**解决方法**：
- 系统自动限制显示前10个推荐
- 检查推荐数据中必需字段是否存在

## 示例输出

成功发送通知后，飞书群组会收到类似这样的卡片：

```
┌────────────────────────────────────┐
│ 📊 趋势跟随策略 - 推荐报告          │
├────────────────────────────────────┤
│ 分析股票数: 99 只                   │
│ 数据时间范围: 2020-01-02 至 2026-02-13 │
│ 推荐数量: 16 只                     │
├────────────────────────────────────┤
│ 🥇 贵州茅台 (600519)               │
│ 📊 推荐: 买入 | 得分: 85.5         │
│ 💰 当前价格: ¥1850.50              │
│ 📈 策略: 加速行情-持有              │
│                                    │
│ 💹 盈利预测:                       │
│    预期收益: +15.5% | 成功率: 75%  │
│    保守目标: ¥1920.00              │
│    适中目标: ¥2050.00              │
│    激进目标: ¥2180.00              │
│    止损价: ¥1750.00                │
│                                    │
│ 📝 理由: 价格突破均线密集区，       │
│          成交量放大，趋势向上        │
├────────────────────────────────────┤
│ ... (更多推荐)                     │
├────────────────────────────────────┤
│ ⚠️ 投资有风险，入市需谨慎           │
│ 本报告仅供参考，不构成投资建议       │
│ 生成时间: 2026-02-23 20:30:00     │
└────────────────────────────────────┘
```

## 相关文件

- **配置文件**：`config/config.yaml`
- **通知器代码**：`src/notification/notifier.py`
- **主程序**：`src/main.py`
- **测试脚本**：`test_feishu_send.py`

## 更多信息

- 飞书机器人开发文档：https://open.feishu.cn/document/ukTMukTMukTM/ucTM5YjL3ETO24yNxkjN
- 卡片消息格式：https://open.feishu.cn/document/ukTMukTMukTM/uADMwUjLwADM14CMwATN
